<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>STOMP WebSocket è°ƒè¯•å°</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #fafafa;
        }

        h1 { margin-bottom: 10px; }

        .status {
            padding: 8px 12px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-weight: bold;
        }

        .connected { background: #e6fffa; color: #065f46; }
        .disconnected { background: #fee2e2; color: #7f1d1d; }

        .section {
            margin-top: 15px;
            padding: 12px;
            border: 1px solid #ddd;
            background: #fff;
        }

        input, button {
            padding: 6px;
            margin: 4px 0;
        }

        button {
            cursor: pointer;
        }

        .log {
            font-size: 13px;
            margin-top: 10px;
            background: #111827;
            color: #e5e7eb;
            padding: 10px;
            height: 280px;
            overflow-y: auto;
        }

        .log div { margin-bottom: 4px; }
        .log .sys { color: #93c5fd; }
        .log .send { color: #facc15; }
        .log .recv { color: #86efac; }
        .log .warn { color: #fca5a5; }
    </style>
</head>
<body>

<h1>STOMP WebSocket è°ƒè¯•å°</h1>

<div id="status" class="status disconnected">ğŸ”´ æœªè¿æ¥</div>

<div class="section">
    <h3>è¿æ¥ä¿¡æ¯</h3>
    <input id="userId" value="10001" placeholder="userId"/>
    <input id="username" value="é˜¿è…¾" placeholder="username"/>
    <input id="token" value="Admin@123" placeholder="token"/>
    <br/>
    <button onclick="connect()">è¿æ¥</button>
    <button onclick="disconnect()">æ–­å¼€</button>
</div>

<div class="section">
    <h3>å¹¿æ’­æ¶ˆæ¯</h3>
    <input id="messageToAll" placeholder="å‘é€ç»™æ‰€æœ‰ç”¨æˆ·"/>
    <button onclick="sendToAll()">å‘é€</button>
</div>

<div class="section">
    <h3>ç§èŠ</h3>
    <input id="targetUserId" placeholder="ç›®æ ‡ç”¨æˆ·ID"/>
    <input id="messageToUser" placeholder="ç§èŠå†…å®¹"/>
    <button onclick="sendToUser()">å‘é€</button>
</div>

<div class="section">
    <h3>ç¾¤èŠ</h3>
    <input id="groupId" placeholder="ç¾¤ID"/>
    <input id="messageToGroup" placeholder="ç¾¤æ¶ˆæ¯"/>
    <br/>
    <button onclick="sendToGroup()">å‘é€</button>
    <button onclick="subscribeGroupByInput()">è®¢é˜…ç¾¤</button>
    <button onclick="unsubscribeGroupByInput()">é€€è®¢ç¾¤</button>
</div>

<div class="section">
    <h3>æ—¥å¿—</h3>
    <div id="log" class="log"></div>
</div>

<script>
    let socket;
    let stompClient;
    let heartbeatTimer;

    const WS_URL = "http://localhost:18002/ws";
    const HEARTBEAT_INTERVAL = 30_000;
    const groupSubscriptions = new Map();

    function setStatus(connected) {
        const el = document.getElementById("status");
        el.className = "status " + (connected ? "connected" : "disconnected");
        el.textContent = connected ? "ğŸŸ¢ å·²è¿æ¥" : "ğŸ”´ æœªè¿æ¥";
    }

    function log(msg, type = "sys") {
        const el = document.getElementById("log");
        const div = document.createElement("div");
        div.className = type;
        div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        el.appendChild(div);
        el.scrollTop = el.scrollHeight;
    }

    function connect() {
        if (stompClient?.connected) {
            log("å·²è¿æ¥ï¼Œæ— éœ€é‡å¤è¿æ¥", "warn");
            return;
        }

        socket = new SockJS(WS_URL);
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({
            userId: userId.value,
            username: username.value,
            Authorization: "Bearer " + token.value
        }, () => {
            setStatus(true);
            log("WebSocket è¿æ¥æˆåŠŸ");
            subscribeBase();
            startHeartbeat();
        }, err => {
            log("è¿æ¥å¤±è´¥ï¼š" + err, "warn");
        });
    }

    function disconnect() {
        stopHeartbeat();
        groupSubscriptions.forEach(s => s.unsubscribe());
        groupSubscriptions.clear();

        stompClient?.disconnect(() => {
            setStatus(false);
            log("è¿æ¥å·²æ–­å¼€");
        });
    }

    function subscribeBase() {
        stompClient.subscribe("/topic/public", msg => {
            const d = JSON.parse(msg.body);
            log(`ğŸ“¢ å…¬å…± ${d.fromUserId}ï¼š${d.content}`, "recv");
        });

        stompClient.subscribe("/user/queue/message", msg => {
            const d = JSON.parse(msg.body);
            log(`ğŸ‘¤ ç§èŠ ${d.fromUserId}ï¼š${d.content}`, "recv");
        });

        log("åŸºç¡€è®¢é˜…å®Œæˆ");
    }

    function subscribeGroupByInput() {
        const gid = groupId.value;
        if (!gid || groupSubscriptions.has(gid)) return;

        const sub = stompClient.subscribe(`/topic/group.${gid}`, msg => {
            const d = JSON.parse(msg.body);
            log(`ğŸ‘¥ ç¾¤[${gid}] ${d.fromUserId}ï¼š${d.content}`, "recv");
        });

        groupSubscriptions.set(gid, sub);
        log(`è®¢é˜…ç¾¤ ${gid}`);
    }

    function unsubscribeGroupByInput() {
        const gid = groupId.value;
        const sub = groupSubscriptions.get(gid);
        if (!sub) return;
        sub.unsubscribe();
        groupSubscriptions.delete(gid);
        log(`é€€è®¢ç¾¤ ${gid}`);
    }

    function startHeartbeat() {
        heartbeatTimer = setInterval(() => {
            stompClient?.connected &&
            stompClient.send("/app/heartbeat", {}, "");
            log("å¿ƒè·³å‘é€", "sys");
        }, HEARTBEAT_INTERVAL);
    }

    function stopHeartbeat() {
        clearInterval(heartbeatTimer);
    }

    function sendToAll() {
        stompClient.send("/app/public.send", {}, messageToAll.value);
        log("å¹¿æ’­ï¼š" + messageToAll.value, "send");
        messageToAll.value = "";
    }

    function sendToUser() {
        stompClient.send("/app/private.send", {}, JSON.stringify({
            toUserId: targetUserId.value,
            content: messageToUser.value
        }));
        log("ç§èŠ â†’ " + targetUserId.value, "send");
        messageToUser.value = "";
    }

    function sendToGroup() {
        stompClient.send("/app/group.send", {}, JSON.stringify({
            groupId: groupId.value,
            content: messageToGroup.value
        }));
        log("ç¾¤æ¶ˆæ¯ â†’ " + groupId.value, "send");
        messageToGroup.value = "";
    }

    window.onbeforeunload = disconnect;
</script>

</body>
</html>
