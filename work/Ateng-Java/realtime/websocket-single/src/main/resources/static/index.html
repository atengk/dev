<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        button {
            margin-right: 8px;
        }
        #status {
            margin: 10px 0;
            font-weight: bold;
        }
        #log {
            margin-top: 10px;
            padding: 10px;
            height: 260px;
            border: 1px solid #ccc;
            overflow-y: auto;
            background: #f9f9f9;
            font-size: 14px;
        }
    </style>
</head>
<body>

<h2>WebSocket ç¤ºä¾‹</h2>

<div>
    <button onclick="connect()">è¿æ¥</button>
    <button onclick="sendBizMessage()">å‘é€ä¸šåŠ¡æ¶ˆæ¯</button>
    <button onclick="closeWebSocket()">å…³é—­</button>
</div>

<div id="status">çŠ¶æ€ï¼šæœªè¿æ¥</div>
<div id="log"></div>

<script>
    /* ================== é…ç½® ================== */

    const WS_URL = "ws://localhost:18001/ws";
    const HEARTBEAT_INTERVAL = 20 * 1000;

    const RECONNECT_BASE_DELAY = 1000;
    const RECONNECT_MAX_DELAY = 30 * 1000;

    const MESSAGE_TYPE = {
        HEARTBEAT: "HEARTBEAT",
        BIZ: "BIZ"
    };

    const BIZ_CODE = {
        CHAT_SEND: "CHAT_SEND"
    };

    /* ================== çŠ¶æ€ ================== */

    let socket = null;
    let heartbeatTimer = null;
    let reconnectTimer = null;
    let reconnectDelay = RECONNECT_BASE_DELAY;
    let manualClose = false;
    let connecting = false;

    /* ================== è¿æ¥ ================== */

    function connect() {
        if (connecting) {
            log("âš ï¸ æ­£åœ¨è¿æ¥ä¸­ï¼Œè¯·å‹¿é‡å¤æ“ä½œ");
            return;
        }

        if (socket && socket.readyState === WebSocket.OPEN) {
            log("WebSocket å·²è¿æ¥");
            return;
        }

        manualClose = false;
        connecting = true;

        const token = "Admin@123";
        const userId = "10001";

        log("å°è¯•è¿æ¥ WebSocket...");
        setStatus("è¿æ¥ä¸­");

        socket = new WebSocket(
            WS_URL + "?token=" + token + "&userId=" + userId
        );

        socket.onopen = () => {
            connecting = false;
            reconnectDelay = RECONNECT_BASE_DELAY;
            setStatus("å·²è¿æ¥");
            log("âœ… WebSocket è¿æ¥æˆåŠŸ");
            startHeartbeat();
        };

        socket.onmessage = (event) => {
            log("â¬… æ”¶åˆ°æ¶ˆæ¯ï¼š" + event.data);
        };

        socket.onclose = () => {
            connecting = false;
            stopHeartbeat();
            setStatus("å·²æ–­å¼€");
            log("âŒ WebSocket è¿æ¥æ–­å¼€");

            if (!manualClose) {
                scheduleReconnect();
            }
        };

        socket.onerror = () => {
            log("â— WebSocket å‘ç”Ÿé”™è¯¯");
        };
    }

    function closeWebSocket() {
        manualClose = true;
        stopHeartbeat();
        clearReconnect();

        if (socket) {
            socket.close();
            socket = null;
        }

        setStatus("å·²æ‰‹åŠ¨å…³é—­");
        log("ğŸ›‘ WebSocket å·²æ‰‹åŠ¨å…³é—­");
    }

    /* ================== è‡ªåŠ¨é‡è¿ ================== */

    function scheduleReconnect() {
        if (reconnectTimer) {
            return;
        }

        log(`ğŸ”„ ${reconnectDelay / 1000}s åå°è¯•é‡è¿...`);

        reconnectTimer = setTimeout(() => {
            reconnectTimer = null;
            connect();
            reconnectDelay = Math.min(
                reconnectDelay * 2,
                RECONNECT_MAX_DELAY
            );
        }, reconnectDelay);
    }

    function clearReconnect() {
        if (reconnectTimer) {
            clearTimeout(reconnectTimer);
            reconnectTimer = null;
        }
    }

    /* ================== å¿ƒè·³ ================== */

    function startHeartbeat() {
        stopHeartbeat();
        heartbeatTimer = setInterval(() => {
            send({ type: MESSAGE_TYPE.HEARTBEAT });
        }, HEARTBEAT_INTERVAL);
        log("ğŸ’“ å¿ƒè·³å·²å¯åŠ¨");
    }

    function stopHeartbeat() {
        if (heartbeatTimer) {
            clearInterval(heartbeatTimer);
            heartbeatTimer = null;
            log("ğŸ’” å¿ƒè·³å·²åœæ­¢");
        }
    }

    /* ================== æ¶ˆæ¯ ================== */

    function sendBizMessage() {
        send({
            type: MESSAGE_TYPE.BIZ,
            code: BIZ_CODE.CHAT_SEND,
            data: {
                content: "ä½ å¥½ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸šåŠ¡æ¶ˆæ¯",
                time: new Date().toISOString()
            }
        });
    }

    function send(message) {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            log("âŒ WebSocket æœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯");
            return;
        }
        const payload = JSON.stringify(message);
        socket.send(payload);
        log("â¡ å‘é€ï¼š" + payload);
    }

    /* ================== UI ================== */

    function log(message) {
        const el = document.getElementById("log");
        el.innerHTML += message + "<br/>";
        el.scrollTop = el.scrollHeight;
    }

    function setStatus(text) {
        document.getElementById("status").innerText = "çŠ¶æ€ï¼š" + text;
    }
</script>

</body>
</html>
